<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Events - Region 11 TSA Regionals 2026</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        .live-clock {
            text-align: center;
            color: white;
            margin-bottom: 8px;
        }
        .live-clock .clock-time {
            font-size: 2.4rem;
            font-weight: 900;
            letter-spacing: 2px;
        }
        .live-clock .clock-date {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 2px;
        }
        .live-pulse {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(229,57,53,0.25);
            border: 1px solid rgba(229,57,53,0.5);
            padding: 5px 16px;
            border-radius: 50px;
            color: #ff6b6b;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 20px;
        }
        .live-pulse .dot {
            width: 8px; height: 8px;
            background: #e53935;
            border-radius: 50%;
            animation: blink 1.5s ease-in-out infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        .refresh-note {
            text-align: center;
            color: rgba(255,255,255,0.4);
            font-size: 0.7rem;
            margin-bottom: 28px;
        }
        .section-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 1.1rem;
            font-weight: 800;
            max-width: 1100px;
            margin: 0 auto 16px;
            padding: 0 10px;
        }
        .section-label i { font-size: 0.9rem; }
        .section-label .count-badge {
            background: rgba(255,255,255,0.15);
            padding: 2px 10px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .live-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            max-width: 1100px;
            margin: 0 auto 36px;
        }
        .live-card {
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transition: transform 0.2s;
        }
        .live-card:hover { transform: translateY(-3px); }
        .live-card-header {
            padding: 14px 18px;
            color: white;
            position: relative;
        }
        .live-card-header.now { background: #1b5e20; }
        .live-card-header.next { background: #e65100; }
        .live-card-header.done { background: #555; }
        .live-card-header.delayed { background: #b71c1c; }
        .live-card-header h3 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 4px;
            padding-right: 60px;
        }
        .live-card-header .room {
            font-size: 0.75rem;
            opacity: 0.85;
        }
        .live-card-header .status-pill {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 0.6rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            padding: 3px 10px;
            border-radius: 50px;
            text-transform: uppercase;
        }
        .status-pill.now { background: #4caf50; color: white; }
        .status-pill.next { background: #ff9800; color: white; }
        .status-pill.done { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); }
        .status-pill.delayed { background: #e53935; color: white; animation: pulse-badge 2s ease-in-out infinite; }
        @keyframes pulse-badge {
            0%, 100% { box-shadow: 0 0 0 0 rgba(229,57,53,0.5); }
            50% { box-shadow: 0 0 0 5px rgba(229,57,53,0); }
        }
        .tag-badges { display: flex; gap: 4px; margin-bottom: 4px; }
        .tag-badge {
            font-size: 0.55rem; font-weight: 800;
            padding: 1px 6px; border-radius: 3px;
            text-transform: uppercase;
        }
        .tag-ms { background: #1565c0; color: white; }
        .tag-hs { background: #e65100; color: white; }
        .tag-nqe { background: #2e7d32; color: white; }
        .tag-ute { background: #6a1b9a; color: white; }
        .live-card-body {
            padding: 10px 18px 14px;
            font-size: 0.82rem;
            color: #555;
            display: flex;
            gap: 16px;
        }
        .live-card-body .time-block {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .live-card-body .time-block i { color: #999; font-size: 0.7rem; }
        .live-card-body .time-block strong { color: #333; }
        .time-strike {
            text-decoration: line-through;
            opacity: 0.4;
            margin-left: 6px;
            font-size: 0.75rem;
        }
        .ann-bar {
            max-width: 1100px;
            margin: 0 auto 24px;
        }
        .ann-item {
            border-radius: 10px;
            padding: 12px 18px;
            margin-bottom: 10px;
            color: white;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .ann-item.info { background: rgba(21,101,192,0.25); border-left: 4px solid #42a5f5; }
        .ann-item.warning { background: rgba(239,108,0,0.2); border-left: 4px solid #ffa726; }
        .ann-item.urgent { background: rgba(198,40,40,0.25); border-left: 4px solid #ef5350; }
        .ann-item.success { background: rgba(46,125,50,0.2); border-left: 4px solid #66bb6a; }
        .ann-item .ann-icon { font-size: 1rem; flex-shrink: 0; padding-top: 2px; }
        .ann-item .ann-text { flex: 1; }
        .ann-item .ann-text strong { font-size: 0.85rem; display: block; margin-bottom: 2px; }
        .ann-item .ann-text p { font-size: 0.82rem; opacity: 0.9; margin: 0; line-height: 1.4; }
        .ann-item .ann-time { font-size: 0.65rem; opacity: 0.5; flex-shrink: 0; padding-top: 3px; }
        .empty-state {
            text-align: center;
            color: rgba(255,255,255,0.5);
            font-size: 0.95rem;
            padding: 30px 0;
            grid-column: 1 / -1;
        }
        .empty-state i { font-size: 1.6rem; margin-bottom: 10px; display: block; }
        .progress-bar {
            position: absolute;
            bottom: 0; left: 0;
            height: 3px;
            background: rgba(255,255,255,0.4);
            border-radius: 0 2px 0 0;
            transition: width 0.5s ease;
        }
        @media (max-width: 768px) {
            .live-grid { grid-template-columns: 1fr; }
            .live-clock .clock-time { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <section class="hero hero-short">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 class="hero-title">Live Events</h1>
            <p class="hero-school">Region 11 TSA Regionals 2026</p>
            <div class="hero-buttons">
                <a href="/" class="btn btn-white">
                    <span class="btn-dot btn-dot-blue"></span> Home
                </a>
                <a href="/schedule" class="btn btn-orange">
                    <span class="btn-dot btn-dot-red"></span> Full Schedule
                </a>
            </div>
        </div>
    </section>

    <section class="info-section">
        <div class="live-clock">
            <div class="clock-time" id="clockTime">--:-- --</div>
            <div class="clock-date" id="clockDate"></div>
        </div>
        <div style="text-align:center;">
            <span class="live-pulse"><span class="dot"></span> Live — Auto-refreshing</span>
        </div>
        <div class="refresh-note" id="refreshNote">Updates every 30 seconds</div>

        <!-- Announcements -->
        <div class="ann-bar" id="annBar"></div>

        <!-- Happening Now -->
        <div id="nowSection">
            <div class="section-label">
                <i class="fas fa-circle" style="color:#4caf50;"></i> Happening Now
                <span class="count-badge" id="nowCount">0</span>
            </div>
            <div class="live-grid" id="nowGrid"></div>
        </div>

        <!-- Up Next -->
        <div id="nextSection">
            <div class="section-label">
                <i class="fas fa-clock" style="color:#ff9800;"></i> Up Next
                <span class="count-badge" id="nextCount">0</span>
            </div>
            <div class="live-grid" id="nextGrid"></div>
        </div>

        <!-- Recently Finished -->
        <div id="doneSection">
            <div class="section-label">
                <i class="fas fa-check-circle" style="color:#999;"></i> Recently Finished
                <span class="count-badge" id="doneCount">0</span>
            </div>
            <div class="live-grid" id="doneGrid"></div>
        </div>
    </section>

    <script>
        // ── Time helpers ──────────────────────────────
        function parseTime(str) {
            if (!str) return null;
            str = str.trim();
            const m = str.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
            if (!m) return null;
            let h = parseInt(m[1]), min = parseInt(m[2]);
            const ampm = m[3].toUpperCase();
            if (ampm === 'PM' && h !== 12) h += 12;
            if (ampm === 'AM' && h === 12) h = 0;
            return h * 60 + min;
        }

        function updateClock() {
            const now = new Date();
            let h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            document.getElementById('clockTime').textContent =
                h + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0') + ' ' + ampm;
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('clockDate').textContent =
                days[now.getDay()] + ', ' + months[now.getMonth()] + ' ' + now.getDate() + ', ' + now.getFullYear();
        }

        // ── Card builder ──────────────────────────────
        function buildCard(ev, status) {
            const headerClass = ev.delayed ? 'delayed' : status;
            const pillClass = ev.delayed ? 'delayed' : status;
            const pillText = ev.delayed ? 'Delayed' : (status === 'now' ? 'Live' : status === 'next' ? 'Soon' : 'Done');

            let tags = '';
            if (ev.tags && ev.tags.length) {
                tags = '<div class="tag-badges">' +
                    ev.tags.map(function(t) { return '<span class="tag-badge tag-' + t.toLowerCase() + '">' + t + '</span>'; }).join('') +
                    '</div>';
            }

            let timeInfo = '';
            const start = ev.activity_start || ev.start;
            const end = ev.activity_end || ev.end;
            if (start) {
                timeInfo += '<div class="time-block"><i class="fas fa-play"></i> <strong>' + start + '</strong>';
                if (ev.delayed && ev.original_start && ev.original_start !== ev.start) {
                    timeInfo += '<span class="time-strike">' + ev.original_start + '</span>';
                }
                timeInfo += '</div>';
            }
            if (end) {
                timeInfo += '<div class="time-block"><i class="fas fa-stop"></i> <strong>' + end + '</strong>';
                if (ev.delayed && ev.original_end && ev.original_end !== ev.end) {
                    timeInfo += '<span class="time-strike">' + ev.original_end + '</span>';
                }
                timeInfo += '</div>';
            }

            // Progress bar for "now" events
            var progressHtml = '';
            if (status === 'now') {
                var startMin = parseTime(start);
                var endMin = parseTime(end);
                var now = new Date();
                var nowMin = now.getHours() * 60 + now.getMinutes();
                if (startMin !== null && endMin !== null && endMin > startMin) {
                    var pct = Math.min(100, Math.max(0, ((nowMin - startMin) / (endMin - startMin)) * 100));
                    progressHtml = '<div class="progress-bar" style="width:' + pct + '%"></div>';
                }
            }

            var roomHtml = '';
            if (ev.room) {
                roomHtml = '<span class="room"><i class="fas fa-door-open"></i> ' + ev.room;
                if (ev.delayed && ev.original_room && ev.original_room !== ev.room) {
                    roomHtml += ' <span class="time-strike">' + ev.original_room + '</span>';
                }
                roomHtml += '</span>';
            }

            return '<div class="live-card">' +
                '<div class="live-card-header ' + headerClass + '">' +
                '<span class="status-pill ' + pillClass + '">' + pillText + '</span>' +
                tags +
                '<h3>' + ev.name + '</h3>' +
                roomHtml +
                progressHtml +
                '</div>' +
                '<div class="live-card-body">' + timeInfo + '</div>' +
                '</div>';
        }

        // ── Classify events ───────────────────────────
        function classifyEvents(events) {
            var now = new Date();
            var nowMin = now.getHours() * 60 + now.getMinutes();
            var nowArr = [], nextArr = [], doneArr = [];

            events.forEach(function(ev) {
                var start = parseTime(ev.activity_start || ev.start);
                var end = parseTime(ev.activity_end || ev.end);
                if (start === null || end === null) return;

                if (nowMin >= start && nowMin <= end + 10) {
                    nowArr.push(ev);
                } else if (nowMin < start && start - nowMin <= 60) {
                    nextArr.push(ev);
                } else if (nowMin > end && nowMin - end <= 90) {
                    doneArr.push(ev);
                }
            });

            nowArr.sort(function(a,b) { return (parseTime(a.activity_end||a.end)||0) - (parseTime(b.activity_end||b.end)||0); });
            nextArr.sort(function(a,b) { return (parseTime(a.activity_start||a.start)||0) - (parseTime(b.activity_start||b.start)||0); });
            doneArr.sort(function(a,b) { return (parseTime(b.activity_end||b.end)||0) - (parseTime(a.activity_end||a.end)||0); });

            return { nowArr: nowArr, nextArr: nextArr, doneArr: doneArr };
        }

        // ── Render ────────────────────────────────────
        function render(data) {
            var dayOfWeek = new Date().getDay();
            var events = [];
            if (dayOfWeek === 5) events = data.friday || [];
            else if (dayOfWeek === 6) events = data.saturday || [];
            else events = (data.friday || []).concat(data.saturday || []);

            var result = classifyEvents(events);

            // Announcements
            var annBar = document.getElementById('annBar');
            var anns = data.announcements || [];
            if (anns.length) {
                var icons = { info: '\u2139\ufe0f', warning: '\u26a0\ufe0f', urgent: '\ud83d\udea8', success: '\u2705' };
                annBar.innerHTML = anns.map(function(a) {
                    return '<div class="ann-item ' + (a.level || 'info') + '">' +
                        '<span class="ann-icon">' + (icons[a.level] || '\u2139\ufe0f') + '</span>' +
                        '<div class="ann-text"><strong>' + (a.title || 'Announcement') + '</strong>' +
                        '<p>' + a.message + '</p></div>' +
                        '<span class="ann-time">' + (a.time || '') + '</span></div>';
                }).join('');
            } else { annBar.innerHTML = ''; }

            // Now
            document.getElementById('nowCount').textContent = result.nowArr.length;
            document.getElementById('nowGrid').innerHTML = result.nowArr.length
                ? result.nowArr.map(function(e) { return buildCard(e, 'now'); }).join('')
                : '<div class="empty-state"><i class="fas fa-pause-circle"></i>No events happening right now</div>';

            // Next
            document.getElementById('nextCount').textContent = result.nextArr.length;
            document.getElementById('nextGrid').innerHTML = result.nextArr.length
                ? result.nextArr.map(function(e) { return buildCard(e, 'next'); }).join('')
                : '<div class="empty-state"><i class="fas fa-hourglass-half"></i>No upcoming events in the next hour</div>';

            // Done
            document.getElementById('doneCount').textContent = result.doneArr.length;
            if (result.doneArr.length) {
                document.getElementById('doneSection').style.display = '';
                document.getElementById('doneGrid').innerHTML = result.doneArr.map(function(e) { return buildCard(e, 'done'); }).join('');
            } else {
                document.getElementById('doneSection').style.display = 'none';
            }
        }

        // ── Initial data from server ──────────────────
        var initialData = {
            friday: {{ friday | tojson }},
            saturday: {{ saturday | tojson }},
            announcements: {{ announcements | tojson }}
        };

        // ── Polling ───────────────────────────────────
        var countdown = 30;

        function fetchLive() {
            fetch('/api/live')
                .then(function(r) { return r.json(); })
                .then(function(data) { render(data); })
                .catch(function(e) { console.warn('Fetch failed:', e); });
            countdown = 30;
        }

        function tick() {
            updateClock();
            countdown--;
            if (countdown <= 0) fetchLive();
            document.getElementById('refreshNote').textContent =
                'Auto-refresh in ' + Math.max(0, countdown) + 's';
        }

        // Boot
        updateClock();
        render(initialData);
        setInterval(tick, 1000);
    </script>
</body>
</html>
